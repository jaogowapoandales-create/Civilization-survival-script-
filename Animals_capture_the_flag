------------------------------------------------------------
-- Wizard UI Full Script (Fixed with Main + Etc... Sections)
------------------------------------------------------------
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")

local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/bloodball/-back-ups-for-libs/main/wizard"))()
local Window = Library:NewWindow("My Hub")
local TabMain = Window:NewSection("Main Features")
local TabEtc = Window:NewSection("Etc...")

-- variables
local AutoFarm = false
local FarmPos1 = CFrame.new(-343.3609, -0.0408, 477.6315)
local FarmPos2 = CFrame.new(256.5446, -0.0408, 477.6288)

local SelectedPlayer = nil
local FollowToggle = false
local AutoKill = false
local AntiKick = false
local AutoFlag = false
local TargetFlag = "Red"
local KillAllServer = false
local InstantKill = false
local SpeedEnabled = false
local WalkSpeedValue = 16
local selectedBanPlayer = nil

-- helper for players list
local function getPlayerNames()
    local t = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(t, p.Name)
        end
    end
    if #t == 0 then
        table.insert(t, "No Players")
    end
    return t
end

------------------------------------------------
-- Main Features Section
------------------------------------------------

-- 1. Auto Farm TP
TabMain:CreateToggle("Auto Farm TP", function(state)
    AutoFarm = state
    if state then
        task.spawn(function()
            while AutoFarm do
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = FarmPos1
                    task.wait(0.5)
                    if not AutoFarm then break end
                    LocalPlayer.Character.HumanoidRootPart.CFrame = FarmPos2
                end
                task.wait(0.5)
            end
        end)
    end
end)

-- 2. Team Switch
TabMain:CreateDropdown("Switch Team", {"Red", "Blue"}, 1, function(teamName)
    local Teams = game:GetService("Teams")
    local team = Teams:FindFirstChild(teamName)
    if team then
        LocalPlayer.Team = team
        StarterGui:SetCore("SendNotification", {Title="Team Switch", Text="Switched to " .. teamName, Duration=2})
    else
        StarterGui:SetCore("SendNotification", {Title="Team Switch", Text="Team not found", Duration=2})
    end
end)

-- 3. Select Player + TP Behind
TabMain:CreateDropdown("Select Player", getPlayerNames(), 1, function(name)
    if name == "No Players" then
        SelectedPlayer = nil
    else
        SelectedPlayer = Players:FindFirstChild(name)
    end
end)

TabMain:CreateToggle("TP Behind Player", function(state)
    FollowToggle = state
    if state then
        task.spawn(function()
            while FollowToggle do
                if SelectedPlayer and SelectedPlayer.Character and SelectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    local targetHRP = SelectedPlayer.Character.HumanoidRootPart
                    local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if myHRP then
                        myHRP.CFrame = targetHRP.CFrame * CFrame.new(0, 2, 3)
                    end
                end
                task.wait(0.2)
            end
        end)
    end
end)

-- 4. Auto Kill All
TabMain:CreateToggle("Auto Kill All", function(state)
    AutoKill = state
    if state then
        task.spawn(function()
            while AutoKill do
                local myTeam = LocalPlayer.Team
                local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                local closest, closestDist = nil, math.huge
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr ~= LocalPlayer and plr.Team and myTeam and plr.Team ~= myTeam and plr.Character then
                        local hum = plr.Character:FindFirstChildOfClass("Humanoid")
                        local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
                        if hum and hrp and hum.Health > 0 and myHRP then
                            local d = (myHRP.Position - hrp.Position).Magnitude
                            if d < closestDist then
                                closestDist = d
                                closest = plr
                            end
                        end
                    end
                end
                if closest and closest.Character then
                    local hrp2 = closest.Character:FindFirstChild("HumanoidRootPart")
                    local hum2 = closest.Character:FindFirstChildOfClass("Humanoid")
                    if hrp2 and hum2 and hum2.Health > 0 then
                        local myHRP2 = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if myHRP2 then
                            myHRP2.CFrame = hrp2.CFrame * CFrame.new(0, 2, 3)
                            local tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
                            if tool and tool:FindFirstChild("Activate") then
                                tool:Activate()
                            end
                        end
                    end
                end
                task.wait(0.05)
            end
        end)
    end
end)

-- 5. Anti Kick
TabMain:CreateToggle("Anti Kick", function(state)
    AntiKick = state
end)

do
    local ok_mt, mt = pcall(getrawmetatable, game)
    if ok_mt and mt then
        local oldNamecall = mt.__namecall
        setreadonly(mt, false)
        mt.__namecall = newcclosure(function(self, ...)
            local method = getnamecallmethod()
            if AntiKick and self == LocalPlayer and method == "Kick" then
                return nil
            end
            return oldNamecall(self, ...)
        end)
        setreadonly(mt, true)
    end
end

-- 6. Auto Grab Flag
TabMain:CreateDropdown("Choose Flag", {"Red", "Blue"}, 1, function(choice)
    TargetFlag = choice
end)

TabMain:CreateToggle("Auto Grab Flag", function(state)
    AutoFlag = state
    if state then
        task.spawn(function()
            while AutoFlag do
                local myTeam = LocalPlayer.Team
                local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if myTeam and myHRP then
                    local flag = workspace:FindFirstChild(TargetFlag .. "Flag")
                    local base = workspace:FindFirstChild(myTeam.Name .. "Base")
                    if flag and base then
                        myHRP.CFrame = flag.CFrame + Vector3.new(0,3,0)
                        task.wait(0.5)
                        myHRP.CFrame = base.CFrame + Vector3.new(0,5,0)
                    end
                end
                task.wait(1)
            end
        end)
    end
end)

-- 7. Kill All Server
TabMain:CreateToggle("Kill All Server", function(state)
    KillAllServer = state
    if state then
        task.spawn(function()
            while KillAllServer do
                local myTeam = LocalPlayer.Team
                local ok_ev, damageEvent = pcall(function()
                    return ReplicatedStorage:WaitForChild("Events"):WaitForChild("DamageEvent")
                end)
                if not ok_ev or not damageEvent then
                    StarterGui:SetCore("SendNotification", {Title="Error", Text="DamageEvent not found", Duration=3})
                    break
                end
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr ~= LocalPlayer and plr.Team and myTeam and plr.Team ~= myTeam and plr.Character then
                        local hum = plr.Character:FindFirstChildOfClass("Humanoid")
                        if hum and hum.Health > 0 then
                            pcall(function()
                                damageEvent:FireServer(plr)
                            end)
                        end
                    end
                end
                task.wait(0.2)
            end
        end)
    end
end)

------------------------------------------------
-- Etc... Section
------------------------------------------------

-- 8. Instant Kill All
TabEtc:CreateToggle("Instant Kill All", function(state)
    InstantKill = state
    if state then
        task.spawn(function()
            while InstantKill do
                local myTeam = LocalPlayer.Team
                local ok_ev, damageEvent = pcall(function()
                    return ReplicatedStorage:WaitForChild("Events"):WaitForChild("DamageEvent")
                end)
                if not ok_ev or not damageEvent then
                    StarterGui:SetCore("SendNotification", {Title="Error", Text="DamageEvent missing", Duration=3})
                    break
                end
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr ~= LocalPlayer and plr.Team and myTeam and plr.Team ~= myTeam and plr.Character then
                        local hum = plr.Character:FindFirstChildOfClass("Humanoid")
                        if hum and hum.Health > 0 then
                            pcall(function()
                                damageEvent:FireServer(plr)
                                damageEvent:FireServer(plr)
                                damageEvent:FireServer(plr)
                            end)
                        end
                    end
                end
                task.wait(0.01)
            end
        end)
    end
end)

-- 9. Speed Control
TabEtc:CreateTextbox("WalkSpeed", function(value)
    local n = tonumber(value)
    if n and n > 0 then
        WalkSpeedValue = n
        if SpeedEnabled then
            local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if hum then hum.WalkSpeed = WalkSpeedValue end
        end
        StarterGui:SetCore("SendNotification", {Title="Speed", Text="Set to "..WalkSpeedValue, Duration=2})
    else
        StarterGui:SetCore("SendNotification", {Title="Speed", Text="Invalid", Duration=2})
    end
end)

TabEtc:CreateToggle("Enable WalkSpeed", function(state)
    SpeedEnabled = state
    if state then
        local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hum then hum.WalkSpeed = WalkSpeedValue end
    else
        local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hum then hum.WalkSpeed = 16 end
    end
end)

LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid")
    if SpeedEnabled then
        char.Humanoid.WalkSpeed = WalkSpeedValue
    else
        char.Humanoid.WalkSpeed = 16
    end
end)

-- 10. Mobile Button
TabEtc:CreateButton("Mobile", function()
    StarterGui:SetCore("SendNotification", {
        Title = "Mobile Button",
        Text = "Pressed!",
        Duration = 2
    })
end)

-- 12. Ban Player
TabEtc:CreateDropdown("Select Player to Ban", getPlayerNames(), 1, function(name)
    if name == "No Players" then
        selectedBanPlayer = nil
    else
        selectedBanPlayer = Players:FindFirstChild(name)
    end
end)

TabEtc:CreateButton("Ban Player", function()
    if selectedBanPlayer and selectedBanPlayer.Parent then
        local ok_ev, banEvent = pcall(function()
            return ReplicatedStorage:WaitForChild("Events"):WaitForChild("BanEvent")
        end)
        if not ok_ev or not banEvent then
            StarterGui:SetCore("SendNotification", {Title="Error", Text="BanEvent missing", Duration=3})
            return
        end
        banEvent:FireServer(selectedBanPlayer)
        StarterGui:SetCore("SendNotification", {Title="Ban", Text="Banned " .. selectedBanPlayer.Name, Duration=2})
    else
        StarterGui:SetCore("SendNotification", {Title="Ban", Text="No player selected", Duration=2})
    end
end)

StarterGui:SetCore("SendNotification", {Title="Wizard UI", Text="Loaded", Duration=2})
